services:
  - docker

before_install:
  - docker pull microsoft/mssql-server-linux:latest
  - docker network create sqlserver_net
  - |
    docker run -e 'ACCEPT_EULA=Y' -e 'MSSQL_SA_PASSWORD=Password12!' \
      --network sqlserver_net -p 1433:1433 --name mssqldb -d microsoft/mssql-server-linux
  - sleep 90
  - docker cp inst/setup.sql mssqldb:.
  - |
    docker exec -t mssqldb /opt/mssql-tools/bin/sqlcmd \
      -S localhost -U SA -P 'Password12!' \
      -i setup.sql

install:
  - docker build -t rsqlserver -f .ci/Dockerfile .

script:
  - |
    docker run -t --network sqlserver_net --name pkgcheck rsqlserver Rscript \
      -e 'devtools::install_dev_deps()' \
      -e 'devtools::install(".")' \
      -e 'library(rsqlserver);server<-"mssqldb";dbname<-"rsqlserverdb";user<-"sa";password<-"Password12!";url <- sprintf("Server=%s;Database=%s;User Id=%s;Password=%s;",server, dbname, user, password);con <- dbConnect("SqlServer", url = url);testthat::expect_equal(dbGetInfo(con, "State")$State, "Open")'
  - exit 0
